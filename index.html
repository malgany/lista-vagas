<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Vagas</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121933;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #6ee7b7;
      --accent-2: #60a5fa;
      --danger: #f87171;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, #0b1020 0%, #0a0f1c 100%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;

      /* default: prevent text selection in non-interactive areas */
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    /* Re-enable selection & pointer for interactive elements */
    input, textarea, button, a, td[data-col], input[type="checkbox"], #vagaForm, #vagaForm * {
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      user-select: text !important;
      cursor: auto;
    }

    .container {
      max-width: 1100px;
      margin: 24px auto 120px;
      padding: 0 16px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    h1 {
      margin: 0;
      font-size: clamp(22px, 3vw, 32px);
      letter-spacing: .4px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    /* Alinhamento ajustado: inputs alinhados ao baseline do botão */
    .form {
      display: grid;
      grid-template-columns: 1.2fr 1.5fr 1fr auto;
      gap: 14px;
      padding: 18px;
      align-items: end;
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(6px);
    }

    .form > div { display: flex; flex-direction: column; justify-content: flex-end; }

    label { font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="url"], input[type="date"], textarea {
      width: 100%;
      background: #0f1530;
      color: var(--text);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease;
      height: 42px;
      box-sizing: border-box;
    }
    input:focus, textarea:focus { border-color: var(--accent-2); box-shadow: 0 0 0 4px rgba(96,165,250,.15); }

    button {
      height: 42px;
      border: none;
      padding: 0 16px;
      font-weight: 600;
      border-radius: 10px;
      color: #0b1020;
      background: linear-gradient(180deg, var(--accent-2), #3b82f6);
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform .06s ease, filter .2s ease;
      white-space: nowrap;
    }
    button:hover { filter: brightness(1.05); }
    button:active { transform: translateY(1px); }
    .btn-secondary { background: linear-gradient(180deg, #a5b4fc, #818cf8); }
    .btn-danger { background: linear-gradient(180deg, #fda4af, #f87171); }
    .btn-ghost { background: transparent; color: var(--text); border: 1px solid rgba(255,255,255,.18); }

    .table-wrapper { margin-top: 28px; padding: 12px 14px; overflow:auto; }

    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    thead th {
      text-align: left;
      font-size: 12px;
      letter-spacing: .5px;
      color: var(--muted);
      padding: 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      user-select: none;
      cursor: pointer;
      position: relative;
    }

    /* fixed column widths to avoid layout shift when editing */
    thead th[data-col="empresa"] { width: 28%; }
    thead th[data-col="link"] { width: 40%; }
    thead th[data-col="data"] { width: 15%; }
    thead th:nth-child(4) { width: 8%; }
    thead th:nth-child(5) { width: 9%; }

    tbody td { padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,.08); vertical-align: middle; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    tbody tr:hover { background: rgba(255,255,255,.03); }
    tbody tr { position: relative; }

    .sort-indicator { position: absolute; right: 8px; opacity: .7; }

    .link { color: #c7d2fe; text-decoration: none; border-bottom: 1px dashed rgba(199,210,254,.5); }
    .link:hover { text-decoration: underline; }

    /* Completed row */
    tbody tr.completed td { color: var(--muted); opacity: 0.6; }

    /* Editable cell styles */
    td.editing { padding: 10px; }
    td .inline-edit { display:block; width:100%; height:36px; box-sizing:border-box; border-radius:8px; padding:6px 10px; background:#0b1228; color:var(--text); border:1px solid rgba(255,255,255,.06); }

    td:focus { outline: 2px solid rgba(96,165,250,.14); outline-offset: -2px; }

    /* ensure delete column cells center their contents */
    td.delete-cell { display:flex; align-items:center; justify-content:center; }

    /* Delete button + confirm popover */
    .delete-btn {
      width:34px; height:34px; border-radius:8px; display:inline-grid; place-items:center;
      background:transparent; border:1px solid rgba(255,255,255,.08); color:var(--text); cursor:pointer; transition:transform .12s ease, background .12s ease;
      font-size:14px; line-height:1; padding:0;
    }
    .delete-btn:hover { transform: translateY(-2px) scale(1.03); background: rgba(248,113,113,.12); }

    .delete-pop { position: absolute; right: 8px; top: 50%; transform: translateY(-50%) scale(.96); opacity:0; transition: transform .16s ease, opacity .16s ease; background: #0f1530; border: 1px solid rgba(255,255,255,.08); padding: 8px; border-radius: 10px; min-width:180px; box-shadow: var(--shadow); display:flex; gap:8px; align-items:center; z-index:80; }
    .delete-pop.open { transform: translateY(-50%) scale(1); opacity:1; }
    .delete-pop p { margin:0; font-size:13px; color:var(--muted); }
    .delete-pop button { height:34px; }
    .delete-count { font-weight:700; color:var(--danger); margin-left:6px; }

    /* Tooltip arrow */
    .delete-pop::after { content: ''; position:absolute; right:-8px; top:50%; transform:translateY(-50%); width:0; height:0; border-left:8px solid rgba(0,0,0,0); }

    /* Toast */
    .toast-area { position: fixed; bottom: 18px; right: 18px; display: grid; gap: 8px; z-index: 90; }
    .toast { background: #0f1530; border: 1px solid rgba(255,255,255,.16); color: var(--text); border-left: 6px solid var(--accent); padding: 10px 12px; border-radius: 10px; box-shadow: var(--shadow); animation: slideIn .22s ease; }
    .toast.error { border-left-color: var(--danger); }
    @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    @media (max-width: 820px) {
      .form { grid-template-columns: 1fr; position: static; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Controle de Vagas</h1>
      <div class="toolbar">
        <button id="btnCopyLink" class="btn-secondary" title="Copiar link com os dados">Copiar link</button>
      </div>
    </div>

    <!-- Formulário no topo -->
    <form id="vagaForm" class="card form" autocomplete="off">
      <div>
        <label for="empresa">Nome da empresa</label>
        <input id="empresa" name="empresa" type="text" placeholder="Ex.: Acme Ltda" required />
      </div>
      <div>
        <label for="link">Link da vaga</label>
        <input id="link" name="link" type="url" placeholder="https://exemplo.com/vaga" required />
      </div>
      <div>
        <label for="data">Data de submissão</label>
        <input id="data" name="data" type="date" required />
      </div>
      <div>
        <button id="btnIncluir" type="submit">Incluir</button>
      </div>
    </form>

    <!-- Tabela na parte de baixo -->
    <div class="card table-wrapper">
      <table id="tabela">
        <thead>
          <tr>
            <th data-col="empresa">EMPRESA <span class="sort-indicator" aria-hidden>▾</span></th>
            <th data-col="link">LINK</th>
            <th data-col="data">DATA</th>
            <th>CONCLUÍDO</th>
            <th>EXCLUIR</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="toast-area" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <script>
    (function() {
      const STORAGE_KEY = 'vagasDataV1';
      /** @type {{empresa:string, link:string, data:string, concluido?:boolean}[]} */
      let vagas = [];
      // sortState.col === null -> keep insertion order (after partition by concluido)
      let sortState = { col: null, dir: 'asc' };

      const form = document.getElementById('vagaForm');
      const empresaEl = document.getElementById('empresa');
      const linkEl = document.getElementById('link');
      const dataEl = document.getElementById('data');
      const tbody = document.getElementById('tbody');
      const thead = document.querySelector('#tabela thead');
      const btnCopyLink = document.getElementById('btnCopyLink');

      // define default date behavior: prefill form date with today if empty
      function setDefaultDate() {
        try {
          const today = new Date();
          const y = today.getFullYear();
          const m = String(today.getMonth() + 1).padStart(2, '0');
          const d = String(today.getDate()).padStart(2, '0');
          if (!dataEl.value) dataEl.value = `${y}-${m}-${d}`;
        } catch (e) { /* ignore */ }
      }

      function showToast(msg, type = 'ok') {
        const area = document.getElementById('toasts');
        const t = document.createElement('div');
        t.className = 'toast' + (type === 'error' ? ' error' : '');
        t.textContent = msg;
        area.appendChild(t);
        setTimeout(() => t.remove(), 3600);
      }

      function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(vagas));
      }

      function load() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          vagas = raw ? JSON.parse(raw) : [];
          // normalizar datas para YYYY-MM-DD and ensure 'concluido'
          for (const v of vagas) {
            if (v.data && v.data.includes('/')) v.data = toISODate(v.data);
            if (typeof v.concluido !== 'boolean') v.concluido = false;
          }
        } catch (e) {
          console.error(e);
          vagas = [];
        }
      }

      function sanitize(str) { return (str || '').toString().trim(); }

      function isValidUrl(u) {
        try { new URL(u); return true; } catch { return false; }
      }

      function toDisplayDate(iso) {
        if (!iso) return '';
        // expect YYYY-MM-DD
        const [y,m,d] = iso.split('-');
        if (!y || !m || !d) return iso;
        return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${y}`;
      }

      function toISODate(val) {
        // Accepts 'YYYY-MM-DD' or 'DD/MM/YYYY'
        if (!val) return '';
        if (val.includes('/')) {
          const [d, m, y] = val.split('/');
          return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
        }
        return val; // assume already ISO
      }

      function addOrUpdate(entry) {
        const idx = vagas.findIndex(v => v.link === entry.link);
        if (idx >= 0) {
          vagas[idx] = entry; // substituir
          return 'replaced';
        } else {
          vagas.push(entry);
          return 'added';
        }
      }

      function importFromArray(arr) {
        // arr: array of objects {empresa,link,data,concluido}
        let added = 0, updated = 0, skipped = 0;
        for (const raw of arr) {
          if (!raw || typeof raw !== 'object') { skipped++; continue; }
          const empresa = sanitize(raw.empresa);
          const link = sanitize(raw.link);
          let dt = sanitize(raw.data);
          dt = toISODate(dt);
          const concluido = raw.concluido === true || raw.concluido === 'true';
          if (!empresa || !link || !dt || !isValidUrl(link)) { skipped++; continue; }
          const idx = vagas.findIndex(v => v.link === link);
          if (idx === -1) {
            vagas.push({ empresa, link, data: dt, concluido });
            added++;
          } else {
            const existing = vagas[idx];
            // compare fields, update only if different
            if (existing.empresa !== empresa || existing.data !== dt || !!existing.concluido !== !!concluido) {
              vagas[idx] = { empresa, link, data: dt, concluido };
              updated++;
            } // else identical -> skip
          }
        }
        if (added || updated) save();
        return { added, updated, skipped };
      }

      // return sequence of focusable editing elements in DOM order
      function getFocusableSequence() {
        const seq = [];
        const rows = Array.from(tbody.querySelectorAll('tr'));
        for (const tr of rows) {
          const empresaTd = tr.querySelector('td[data-col="empresa"]');
          const linkTd = tr.querySelector('td[data-col="link"]');
          const dataTd = tr.querySelector('td[data-col="data"]');
          const chk = tr.querySelector('input[type="checkbox"]');
          const delBtn = tr.querySelector('.delete-btn');
          if (empresaTd) seq.push(empresaTd);
          if (linkTd) seq.push(linkTd);
          if (dataTd) seq.push(dataTd);
          if (chk) seq.push(chk);
          if (delBtn) seq.push(delBtn);
        }
        return seq;
      }

      function focusElement(el) {
        if (!el) return;
        // if td -> focus it (which will enter edit)
        if (el.tagName === 'TD') el.focus();
        else el.focus();
      }

      // close any active inline edit (commit) to avoid multiple inputs/caret leakage
      function closeActiveEdit() {
        const activeTd = tbody.querySelector('td.editing');
        if (!activeTd) return;
        const input = activeTd.querySelector('.inline-edit');
        if (input) {
          try { commitEdit(input, activeTd); } catch (e) { activeTd.classList.remove('editing'); renderTable(); }
        } else {
          activeTd.classList.remove('editing');
        }
      }

      function enterEdit(td) {
        if (!td || td.classList.contains('editing')) return;
        const col = td.dataset.col;
        if (!col) return;

        // close any other active edit first
        closeActiveEdit();

        // store anchor href before clearing
        let anchorHref = null;
        const anchor = td.querySelector && td.querySelector('a');
        if (anchor) anchorHref = anchor.href;

        td.classList.add('editing');
        const orig = td.textContent.trim();
        td.innerHTML = '';

        let input;
        if (col === 'data') {
          input = document.createElement('input');
          input.type = 'date';
          const iso = toISODate(orig) || anchorHref || '';
          input.value = iso || '';
        } else if (col === 'link') {
          input = document.createElement('input');
          input.type = 'url';
          input.value = anchorHref || orig;
        } else {
          input = document.createElement('input');
          input.type = 'text';
          input.value = orig;
        }
        input.className = 'inline-edit';
        // ensure input won't visually overflow or move layout
        input.style.display = 'block';
        input.style.minWidth = '0';
        td.appendChild(input);

        // focus/selection deferred to next frame to avoid layout thrash
        requestAnimationFrame(() => {
          input.focus();
          try { input.select(); } catch (e) {}
        });

        // handlers
        input.addEventListener('blur', () => {
          // small timeout to allow related clicks (eg. Cancel button) before committing
          setTimeout(() => { if (document.activeElement === input) return; commitEdit(input, td); }, 0);
        });

        input.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter') {
            ev.preventDefault();
            commitEdit(input, td, { focusMove: 1 });
          } else if (ev.key === 'Tab') {
            ev.preventDefault();
            const dir = ev.shiftKey ? -1 : 1;
            commitEdit(input, td, { focusMove: dir });
          } else if (ev.key === 'Escape') {
            td.classList.remove('editing');
            renderTable();
          }
        });
      }

      function commitEdit(input, td, opts = {}) {
        // opts: { focusMove: number } where focusMove 1 -> next, -1 -> prev, undefined -> none
        if (!td || !input) return;
        const move = opts.focusMove;
        // build sequence BEFORE changes to compute next index
        const seqBefore = getFocusableSequence();
        const tdIndex = seqBefore.indexOf(td);
        const targetIndex = (typeof move === 'number') ? tdIndex + move : null;

        const newValRaw = input.value.trim();
        const col = td.dataset.col;
        const tr = td.closest('tr');
        const originalLink = tr ? tr.dataset.link : null;
        const idx = vagas.findIndex(v => v.link === originalLink);
        if (idx === -1) { td.classList.remove('editing'); renderTable(); return; }

        let newEmpresa = vagas[idx].empresa;
        let newLink = vagas[idx].link;
        let newData = vagas[idx].data;

        if (col === 'empresa') {
          if (!newValRaw) { showToast('Nome da empresa não pode ficar vazio', 'error'); input.focus(); return; }
          newEmpresa = newValRaw;
        } else if (col === 'link') {
          if (!isValidUrl(newValRaw)) { showToast('Link inválido', 'error'); input.focus(); return; }
          newLink = newValRaw;
          const conflict = vagas.findIndex((v, i) => v.link === newLink && i !== idx);
          if (conflict !== -1) { showToast('Já existe uma vaga com esse link', 'error'); input.focus(); return; }
        } else if (col === 'data') {
          const iso = toISODate(newValRaw);
          if (!iso) { showToast('Data inválida', 'error'); input.focus(); return; }
          newData = iso;
        }

        vagas[idx] = { empresa: newEmpresa, link: newLink, data: newData, concluido: !!vagas[idx].concluido };
        save();
        renderTable();

        // after render, focus desired element by index if valid. Use setTimeout to ensure DOM updates are applied.
        if (typeof targetIndex === 'number') {
          setTimeout(() => {
            const seqAfter = getFocusableSequence();
            if (targetIndex >= 0 && targetIndex < seqAfter.length) {
              const el = seqAfter[targetIndex];
              // if td -> start edit
              if (el && el.tagName === 'TD') enterEdit(el);
              else focusElement(el);
            }
          }, 0);
        }
      }

      function renderTable() {
        const withIndex = vagas.map((v, i) => ({ ...v, __idx: i }));

        const sorted = withIndex.sort((a,b) => {
          if ((a.concluido || false) !== (b.concluido || false)) return a.concluido ? 1 : -1;
          if (!sortState.col) return a.__idx - b.__idx;
          const col = sortState.col;
          let av = a[col] || '', bv = b[col] || '';
          if (col === 'data') { av = a.data || ''; bv = b.data || ''; }
          else { av = av.toString().toLowerCase(); bv = bv.toString().toLowerCase(); }
          if (av < bv) return sortState.dir === 'asc' ? -1 : 1;
          if (av > bv) return sortState.dir === 'asc' ? 1 : -1;
          return a.__idx - b.__idx;
        });

        // close any stray edits before re-render
        const active = tbody.querySelector('td.editing');
        if (active) active.classList.remove('editing');

        tbody.innerHTML = '';
        for (const v of sorted) {
          const tr = document.createElement('tr');
          tr.dataset.link = v.link;
          if (v.concluido) tr.classList.add('completed');

          const tdEmpresa = document.createElement('td');
          tdEmpresa.dataset.col = 'empresa';
          tdEmpresa.tabIndex = 0;
          tdEmpresa.textContent = v.empresa;

          const tdLink = document.createElement('td');
          tdLink.dataset.col = 'link';
          tdLink.tabIndex = 0;
          const a = document.createElement('a');
          a.href = v.link; a.target = '_blank'; a.rel = 'noopener noreferrer';
          a.textContent = v.link; a.className = 'link';
          tdLink.appendChild(a);

          const tdData = document.createElement('td');
          tdData.dataset.col = 'data';
          tdData.tabIndex = 0;
          tdData.textContent = toDisplayDate(v.data);

          const tdConcluido = document.createElement('td');
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.tabIndex = 0;
          chk.checked = !!v.concluido;
          chk.addEventListener('change', () => {
            const origIdx = vagas.findIndex(x => x.link === v.link);
            if (origIdx >= 0) {
              vagas[origIdx].concluido = chk.checked;
              save();
              renderTable();
            }
          });
          tdConcluido.appendChild(chk);

          const tdDelete = document.createElement('td');
          tdDelete.className = 'delete-cell';
          const delBtn = document.createElement('button');
          delBtn.className = 'delete-btn';
          delBtn.title = 'Excluir';
          delBtn.tabIndex = 0;
          // SVG cross icon for crispness
          delBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M6 6L18 18M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
          tdDelete.appendChild(delBtn);

          // attach delete flow
          delBtn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            if (tr.querySelector('.delete-pop')) return;
            const pop = document.createElement('div');
            pop.className = 'delete-pop';
            const p = document.createElement('p');
            p.innerHTML = 'Excluindo em <span class="delete-count">5</span>s';
            const btnCancel = document.createElement('button');
            btnCancel.className = 'btn-ghost';
            btnCancel.textContent = 'Cancelar';
            pop.appendChild(p);
            pop.appendChild(btnCancel);

            tr.appendChild(pop);

            // animate open
            requestAnimationFrame(() => pop.classList.add('open'));

            let count = 5;
            const span = pop.querySelector('.delete-count');
            const timer = setInterval(() => {
              count--;
              if (span) span.textContent = String(count);
              if (count <= 0) {
                clearInterval(timer);
                const idx = vagas.findIndex(x => x.link === v.link);
                if (idx >= 0) {
                  vagas.splice(idx, 1);
                  save();
                  renderTable();
                  showToast('Vaga excluída');
                }
              }
            }, 1000);

            btnCancel.addEventListener('click', (e) => {
              e.stopPropagation();
              clearInterval(timer);
              pop.classList.remove('open');
              setTimeout(() => pop.remove(), 160);
            });

            // focus cancel with keyboard
            btnCancel.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btnCancel.click(); } });
          });

          // keyboard support: enter/space on delBtn triggers click
          delBtn.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); delBtn.click(); } });

          // checkbox keyboard toggle
          chk.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); chk.checked = !chk.checked; chk.dispatchEvent(new Event('change')); } });

          tr.appendChild(tdEmpresa);
          tr.appendChild(tdLink);
          tr.appendChild(tdData);
          tr.appendChild(tdConcluido);
          tr.appendChild(tdDelete);
          tbody.appendChild(tr);
        }

        // atualizar indicadores visuais de ordenação
        document.querySelectorAll('thead th').forEach(th => {
          const ind = th.querySelector('.sort-indicator') || document.createElement('span');
          ind.className = 'sort-indicator';
          if (th.dataset.col && th.dataset.col === sortState.col) {
            ind.textContent = sortState.dir === 'asc' ? '▴' : '▾';
          } else {
            ind.textContent = '';
          }
          if (th.dataset.col && !th.querySelector('.sort-indicator')) th.appendChild(ind);
        });
      }

      // delegated clicks to enter edit mode when clicking on TDs (but not on anchors or buttons)
      tbody.addEventListener('click', (e) => {
        const td = e.target.closest('td');
        if (!td || !tbody.contains(td)) return;
        if (td.dataset.col) {
          if (e.target.closest && e.target.closest('a')) return;
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
          enterEdit(td);
        }
      });

      // focus behavior: when td receives focus (via Tab), start edit
      tbody.addEventListener('focusin', (e) => {
        const td = e.target.closest && e.target.closest('td');
        if (!td) return;
        if (td.dataset && td.dataset.col) {
          // if focus came from clicking anchor, don't edit
          if (document.activeElement && document.activeElement.tagName === 'A') return;
          enterEdit(td);
        }
      });

      // disable clicks/selection/drag on non-interactive areas
      (function blockNonInteractive() {
        const allowSelector = 'input, textarea, button, a, td[data-col], input[type="checkbox"], #vagaForm *';
        // prevent mouse clicks on everything that is not allowed
        document.addEventListener('click', (e) => {
          if (e.target.closest && e.target.closest(allowSelector)) return;
          // allow right-click context menu, but prevent accidental selections/clicks
          e.preventDefault();
          e.stopPropagation();
        }, true);

        // prevent text selection start outside allowed
        document.addEventListener('selectstart', (e) => {
          if (e.target.closest && e.target.closest(allowSelector)) return;
          e.preventDefault();
        }, true);

        // prevent dragging items (images/links) outside allowed
        document.addEventListener('dragstart', (e) => {
          if (e.target.closest && e.target.closest(allowSelector)) return;
          e.preventDefault();
        }, true);
      })();

      // keyboard navigation helpers
      document.addEventListener('keydown', (e) => {
        // if an INPUT inline exists and is focused, let it handle keys
        const active = document.activeElement;
        if (active && active.classList && active.classList.contains('inline-edit')) return;

        // Enter/Space behavior for focused checkbox or delete button already handled on render
        // Tab/Shift+Tab default behavior is fine for moving focus between focusable elements (we handled edits on focusin)
      });

      // Eventos
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const empresa = sanitize(empresaEl.value);
        const link = sanitize(linkEl.value);
        const data = toISODate(sanitize(dataEl.value));
        if (!empresa) { showToast('Informe o nome da empresa', 'error'); empresaEl.focus(); return; }
        if (!isValidUrl(link)) { showToast('Link inválido', 'error'); linkEl.focus(); return; }
        if (!data) { showToast('Informe a data', 'error'); dataEl.focus(); return; }
        const res = addOrUpdate({ empresa, link, data, concluido: false });
        save();
        renderTable();
        form.reset();
        setDefaultDate();
        empresaEl.focus();
        showToast(res === 'added' ? 'Vaga incluída' : 'Vaga atualizada');
      });

      thead.addEventListener('click', (e) => {
        const th = e.target.closest('th');
        if (!th) return;
        const col = th.dataset.col;
        if (!col) return; // coluna 'CONCLUÍDO' e 'EXCLUIR' não ordenam por clique
        if (sortState.col === col) {
          sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
        } else {
          sortState.col = col; sortState.dir = 'asc';
        }
        renderTable();
      });

      // construir link compartilhável e copiar
      function buildShareUrl() {
        const base = 'https://malgany.github.io/lista-vagas';
        if (!vagas || vagas.length === 0) return base;
        // compactar apenas os campos necessários
        const payload = vagas.map(v => ({ empresa: v.empresa, link: v.link, data: v.data, concluido: !!v.concluido }));
        const encoded = encodeURIComponent(JSON.stringify(payload));
        return `${base}?vagas=${encoded}`;
      }

      // Use fallback copy method only (avoid Clipboard API which may be blocked by permissions)
      btnCopyLink.addEventListener('click', () => {
        if (!vagas || vagas.length === 0) { showToast('Nada para copiar (sem vagas).', 'error'); return; }
        const url = buildShareUrl();
        try {
          const ta = document.createElement('textarea');
          ta.value = url;
          ta.setAttribute('readonly', '');
          ta.style.position = 'absolute';
          ta.style.left = '-9999px';
          ta.style.top = '0';
          document.body.appendChild(ta);

          ta.focus();
          ta.select();
          ta.setSelectionRange(0, ta.value.length);

          const ok = document.execCommand('copy');
          document.body.removeChild(ta);

          if (ok) {
            showToast('Link copiado para a área de transferência!');
          } else {
            showToast('Não foi possível copiar automaticamente. Selecione e copie manualmente.', 'error');
          }
        } catch (e) {
          console.error('Copy fallback failed', e);
          showToast('Falha ao copiar o link. Copie manualmente: ' + url, 'error');
        }
      });

      // importar automaticamente se houver param ?vagas=...
      function tryImportFromUrl() {
        try {
          const params = new URLSearchParams(window.location.search);
          if (!params.has('vagas')) return;
          const raw = params.get('vagas');
          if (!raw) return;
          let arr;
          try { arr = JSON.parse(raw); } catch (e) {
            // talvez esteja percent-encoded
            try { arr = JSON.parse(decodeURIComponent(raw)); } catch (ee) { return; }
          }
          if (!Array.isArray(arr)) return;
          const { added, updated, skipped } = importFromArray(arr);
          if (added || updated) {
            // atualiza tabela imediatamente
            renderTable();
            // remove o parâmetro da URL para não reimportar em futuros reloads
            try {
              const u = new URL(window.location.href);
              u.searchParams.delete('vagas');
              history.replaceState(null, '', u.toString());
            } catch (e) { console.error(e); }
            // mostra notificação — sem recarregar a página
            showToast(`Import automático: ${added} adicionada(s), ${updated} atualizada(s), ${skipped} ignorada(s)`);
          }
        } catch (err) {
          console.error('Erro importando da URL', err);
        }
      }

      // Inicialização
      load();
      renderTable();
      tryImportFromUrl();

      // Atalhos: ESC fecha modais (não há modais agora, mas deixo como segurança)
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          // nada para fechar
        }
      });
    })();
  </script>
</body>
</html>
