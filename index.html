<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Vagas</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121933;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #6ee7b7;
      --accent-2: #60a5fa;
      --danger: #f87171;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, #0b1020 0%, #0a0f1c 100%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 1100px;
      margin: 24px auto 120px;
      padding: 0 16px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    h1 {
      margin: 0;
      font-size: clamp(22px, 3vw, 32px);
      letter-spacing: .4px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    /* Alinhamento ajustado: inputs alinhados ao baseline do botão */
    .form {
      display: grid;
      grid-template-columns: 1.2fr 1.5fr 1fr auto;
      gap: 14px;
      padding: 18px;
      align-items: end;
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(6px);
    }

    .form > div { display: flex; flex-direction: column; justify-content: flex-end; }

    label { font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="url"], input[type="date"], textarea {
      width: 100%;
      background: #0f1530;
      color: var(--text);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease;
      height: 42px;
      box-sizing: border-box;
    }
    input:focus, textarea:focus { border-color: var(--accent-2); box-shadow: 0 0 0 4px rgba(96,165,250,.15); }

    button {
      height: 42px;
      border: none;
      padding: 0 16px;
      font-weight: 600;
      border-radius: 10px;
      color: #0b1020;
      background: linear-gradient(180deg, var(--accent-2), #3b82f6);
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform .06s ease, filter .2s ease;
      white-space: nowrap;
    }
    button:hover { filter: brightness(1.05); }
    button:active { transform: translateY(1px); }
    .btn-secondary { background: linear-gradient(180deg, #a5b4fc, #818cf8); }
    .btn-danger { background: linear-gradient(180deg, #fda4af, #f87171); }
    .btn-ghost { background: transparent; color: var(--text); border: 1px solid rgba(255,255,255,.18); }

    .table-wrapper { margin-top: 28px; padding: 12px 14px; }

    table { width: 100%; border-collapse: collapse; }
    thead th {
      text-align: left;
      font-size: 12px;
      letter-spacing: .5px;
      color: var(--muted);
      padding: 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      user-select: none;
      cursor: pointer;
      position: relative;
    }
    tbody td { padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,.08); }
    tbody tr:hover { background: rgba(255,255,255,.03); }

    .sort-indicator { position: absolute; right: 8px; opacity: .7; }

    .link {
      color: #c7d2fe; text-decoration: none; border-bottom: 1px dashed rgba(199,210,254,.5);
    }
    .link:hover { text-decoration: underline; }

    /* Completed row */
    tbody tr.completed td { color: var(--muted); opacity: 0.6; }

    /* Toast */
    .toast-area { position: fixed; bottom: 18px; right: 18px; display: grid; gap: 8px; z-index: 60; }
    .toast {
      background: #0f1530; border: 1px solid rgba(255,255,255,.16); color: var(--text);
      border-left: 6px solid var(--accent);
      padding: 10px 12px; border-radius: 10px; box-shadow: var(--shadow);
      animation: slideIn .22s ease;
    }
    .toast.error { border-left-color: var(--danger); }
    @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    @media (max-width: 820px) {
      .form { grid-template-columns: 1fr; position: static; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Controle de Vagas</h1>
      <div class="toolbar">
        <button id="btnCopyLink" class="btn-secondary" title="Copiar link com os dados">Copiar link</button>
      </div>
    </div>

    <!-- Formulário no topo -->
    <form id="vagaForm" class="card form" autocomplete="off">
      <div>
        <label for="empresa">Nome da empresa</label>
        <input id="empresa" name="empresa" type="text" placeholder="Ex.: Acme Ltda" required />
      </div>
      <div>
        <label for="link">Link da vaga</label>
        <input id="link" name="link" type="url" placeholder="https://exemplo.com/vaga" required />
      </div>
      <div>
        <label for="data">Data de submissão</label>
        <input id="data" name="data" type="date" required />
      </div>
      <div>
        <button id="btnIncluir" type="submit">Incluir</button>
      </div>
    </form>

    <!-- Tabela na parte de baixo -->
    <div class="card table-wrapper">
      <table id="tabela">
        <thead>
          <tr>
            <th data-col="empresa">EMPRESA <span class="sort-indicator" aria-hidden>▾</span></th>
            <th data-col="link">LINK</th>
            <th data-col="data">DATA</th>
            <th>CONCLUÍDO</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="toast-area" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <script>
    (function() {
      const STORAGE_KEY = 'vagasDataV1';
      /** @type {{empresa:string, link:string, data:string, concluido?:boolean}[]} */
      let vagas = [];
      // sortState.col === null -> keep insertion order (after partition by concluido)
      let sortState = { col: null, dir: 'asc' };

      const form = document.getElementById('vagaForm');
      const empresaEl = document.getElementById('empresa');
      const linkEl = document.getElementById('link');
      const dataEl = document.getElementById('data');
      const tbody = document.getElementById('tbody');
      const thead = document.querySelector('#tabela thead');
      const btnCopyLink = document.getElementById('btnCopyLink');

      function showToast(msg, type = 'ok') {
        const area = document.getElementById('toasts');
        const t = document.createElement('div');
        t.className = 'toast' + (type === 'error' ? ' error' : '');
        t.textContent = msg;
        area.appendChild(t);
        setTimeout(() => t.remove(), 3600);
      }

      function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(vagas));
      }

      function load() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          vagas = raw ? JSON.parse(raw) : [];
          // normalizar datas para YYYY-MM-DD and ensure 'concluido'
          for (const v of vagas) {
            if (v.data && v.data.includes('/')) v.data = toISODate(v.data);
            if (typeof v.concluido !== 'boolean') v.concluido = false;
          }
        } catch (e) {
          console.error(e);
          vagas = [];
        }
      }

      function sanitize(str) { return (str || '').toString().trim(); }

      function isValidUrl(u) {
        try { new URL(u); return true; } catch { return false; }
      }

      function toDisplayDate(iso) {
        if (!iso) return '';
        // expect YYYY-MM-DD
        const [y,m,d] = iso.split('-');
        if (!y || !m || !d) return iso;
        return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${y}`;
      }

      function toISODate(val) {
        // Accepts 'YYYY-MM-DD' or 'DD/MM/YYYY'
        if (!val) return '';
        if (val.includes('/')) {
          const [d, m, y] = val.split('/');
          return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
        }
        return val; // assume already ISO
      }

      function addOrUpdate(entry) {
        const idx = vagas.findIndex(v => v.link === entry.link);
        if (idx >= 0) {
          vagas[idx] = entry; // substituir
          return 'replaced';
        } else {
          vagas.push(entry);
          return 'added';
        }
      }

      function importFromArray(arr) {
        // arr: array of objects {empresa,link,data,concluido}
        let added = 0, updated = 0, skipped = 0;
        for (const raw of arr) {
          if (!raw || typeof raw !== 'object') { skipped++; continue; }
          const empresa = sanitize(raw.empresa);
          const link = sanitize(raw.link);
          let dt = sanitize(raw.data);
          dt = toISODate(dt);
          const concluido = raw.concluido === true || raw.concluido === 'true';
          if (!empresa || !link || !dt || !isValidUrl(link)) { skipped++; continue; }
          const idx = vagas.findIndex(v => v.link === link);
          if (idx === -1) {
            vagas.push({ empresa, link, data: dt, concluido });
            added++;
          } else {
            const existing = vagas[idx];
            // compare fields, update only if different
            if (existing.empresa !== empresa || existing.data !== dt || !!existing.concluido !== !!concluido) {
              vagas[idx] = { empresa, link, data: dt, concluido };
              updated++;
            } // else identical -> skip
          }
        }
        if (added || updated) save();
        return { added, updated, skipped };
      }

      function renderTable() {
        // map com índice para preservar ordem de inserção quando necessário
        const withIndex = vagas.map((v, i) => ({ ...v, __idx: i }));

        const sorted = withIndex.sort((a,b) => {
          // sempre não concluídos primeiro
          if ((a.concluido || false) !== (b.concluido || false)) return a.concluido ? 1 : -1;

          // se não há coluna de ordenação escolhida, manter ordem de inserção
          if (!sortState.col) return a.__idx - b.__idx;

          const col = sortState.col;
          let av = a[col] || '', bv = b[col] || '';
          if (col === 'data') { av = a.data || ''; bv = b.data || ''; }
          else { av = av.toString().toLowerCase(); bv = bv.toString().toLowerCase(); }

          if (av < bv) return sortState.dir === 'asc' ? -1 : 1;
          if (av > bv) return sortState.dir === 'asc' ? 1 : -1;
          return a.__idx - b.__idx;
        });

        tbody.innerHTML = '';
        for (const v of sorted) {
          const tr = document.createElement('tr');
          if (v.concluido) tr.classList.add('completed');

          const tdEmpresa = document.createElement('td');
          tdEmpresa.textContent = v.empresa;

          const tdLink = document.createElement('td');
          const a = document.createElement('a');
          a.href = v.link; a.target = '_blank'; a.rel = 'noopener noreferrer';
          a.textContent = v.link; a.className = 'link';
          tdLink.appendChild(a);

          const tdData = document.createElement('td');
          tdData.textContent = toDisplayDate(v.data);

          const tdConcluido = document.createElement('td');
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.checked = !!v.concluido;
          chk.addEventListener('change', () => {
            // atualizar campo e salvar
            const origIdx = vagas.findIndex(x => x.link === v.link);
            if (origIdx >= 0) {
              vagas[origIdx].concluido = chk.checked;
              save();
              renderTable();
            }
          });
          tdConcluido.appendChild(chk);

          tr.appendChild(tdEmpresa);
          tr.appendChild(tdLink);
          tr.appendChild(tdData);
          tr.appendChild(tdConcluido);
          tbody.appendChild(tr);
        }

        // atualizar indicadores visuais de ordenação
        document.querySelectorAll('thead th').forEach(th => {
          const ind = th.querySelector('.sort-indicator') || document.createElement('span');
          ind.className = 'sort-indicator';
          if (th.dataset.col && th.dataset.col === sortState.col) {
            ind.textContent = sortState.dir === 'asc' ? '▴' : '▾';
          } else {
            ind.textContent = '';
          }
          if (th.dataset.col && !th.querySelector('.sort-indicator')) th.appendChild(ind);
        });
      }

      // Eventos
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const empresa = sanitize(empresaEl.value);
        const link = sanitize(linkEl.value);
        const data = toISODate(sanitize(dataEl.value));
        if (!empresa) { showToast('Informe o nome da empresa', 'error'); empresaEl.focus(); return; }
        if (!isValidUrl(link)) { showToast('Link inválido', 'error'); linkEl.focus(); return; }
        if (!data) { showToast('Informe a data', 'error'); dataEl.focus(); return; }
        const res = addOrUpdate({ empresa, link, data, concluido: false });
        save();
        renderTable();
        form.reset();
        empresaEl.focus();
        showToast(res === 'added' ? 'Vaga incluída' : 'Vaga atualizada');
      });

      thead.addEventListener('click', (e) => {
        const th = e.target.closest('th');
        if (!th) return;
        const col = th.dataset.col;
        if (!col) return; // coluna 'CONCLUÍDO' não ordena por clique
        if (sortState.col === col) {
          sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
        } else {
          sortState.col = col; sortState.dir = 'asc';
        }
        renderTable();
      });

      // construir link compartilhável e copiar
      function buildShareUrl() {
        const base = 'https://malgany.github.io/lista-vagas';
        if (!vagas || vagas.length === 0) return base;
        // compactar apenas os campos necessários
        const payload = vagas.map(v => ({ empresa: v.empresa, link: v.link, data: v.data, concluido: !!v.concluido }));
        const encoded = encodeURIComponent(JSON.stringify(payload));
        return `${base}?vagas=${encoded}`;
      }

      // Use fallback copy method only (avoid Clipboard API which may be blocked by permissions)
      btnCopyLink.addEventListener('click', () => {
        if (!vagas || vagas.length === 0) { showToast('Nada para copiar (sem vagas).', 'error'); return; }
        const url = buildShareUrl();
        try {
          const ta = document.createElement('textarea');
          // keep textarea offscreen but selectable
          ta.value = url;
          ta.setAttribute('readonly', '');
          ta.style.position = 'absolute';
          ta.style.left = '-9999px';
          ta.style.top = '0';
          document.body.appendChild(ta);

          // select the text
          ta.focus();
          ta.select();
          ta.setSelectionRange(0, ta.value.length);

          const ok = document.execCommand('copy');
          document.body.removeChild(ta);

          if (ok) {
            showToast('Link copiado para a área de transferência!');
          } else {
            // execCommand can return false in some browsers
            showToast('Não foi possível copiar automaticamente. Selecione e copie manualmente.', 'error');
          }
        } catch (e) {
          console.error('Copy fallback failed', e);
          showToast('Falha ao copiar o link. Copie manualmente: ' + url, 'error');
        }
      });

      // importar automaticamente se houver param ?vagas=...
      function tryImportFromUrl() {
        try {
          const params = new URLSearchParams(window.location.search);
          if (!params.has('vagas')) return;
          const raw = params.get('vagas');
          if (!raw) return;
          let arr;
          try { arr = JSON.parse(raw); } catch (e) {
            // talvez esteja percent-encoded
            try { arr = JSON.parse(decodeURIComponent(raw)); } catch (ee) { return; }
          }
          if (!Array.isArray(arr)) return;
          const { added, updated, skipped } = importFromArray(arr);
          if (added || updated) {
            renderTable();
            showToast(`Import automático: ${added} adicionada(s), ${updated} atualizada(s), ${skipped} ignorada(s)`);
          }
        } catch (e) {
          console.error('Erro importando da URL', e);
        }
      }

      // Inicialização
      load();
      renderTable();
      tryImportFromUrl();

      // Atalhos: ESC fecha modais (não há modais agora, mas deixo como segurança)
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          // nada para fechar
        }
      });
    })();
  </script>
</body>
</html>
